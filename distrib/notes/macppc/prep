.\"	$NetBSD: prep,v 1.4 2000/10/27 00:42:58 mbw Exp $
.
.Ss2 Open Firmware System Preparation
.
Most \*M systems have OF bugs.  Luckily, OF has a small Non-Volatile RAM variable
(NVRAM) which is reserved for FORTH commands which will be run before booting an 
operating system.  Apple has released a freeware MacOS tool called System Disk, which patches
most of these bugs.  We 
.Em strongly
recommend that you use this tool to patch your OF,
as several systems cannot boot without these patches.
.Pp
Download System Disk from Apple's site:
.Lk ftp://ftp.apple.com/developer/macosxserver/utilities/SystemDisk2.3.1.smi.bin
.Pp
For a brief tutorial on how to use System Disk, see:
.Lk http://www.netbsd.org/Ports/macppc/SystemDisk-tutorial/
.Pp
Make sure you click the 
.Pa `save'
button, or the patches will not be saved to NVRAM.
.(Note
NVRAM patches will be erased if you `zap your PRAM' by holding down the 
.Pa `Command', `Option', `p',
and
.Pa `r'
keys during the boot chimes
.Note)
.Pp
Now, skip forward to the section appropriate for your version of Open Firmware:
.br
.Sx Open Firmware 1.0.5 or 2.0.x System Preparation
.br
.Sx Open Firmware 1.1.22 System Preparation
.br
.Sx Open Firmware 2.4 System Preparation
.br
.Sx Open Firmware 3 System Preparation
.
.Ss2 Open Firmware 1.0.5 or 2.0.x System Preparation
.
.(enum
.Em Getting to the OF prompt (easy, using MacOS)
.Pp
Launch the MacOS System Disk tool.  Click on 
.Pa `Power User (Open Firmware)'
then click on the
.Pa `Advanced Options'
button.  Now, click on the checkbox that says
.Pa `Stop Boot at Open Firmware prompt'
and hit
.Pa `OK'.
Click the
.Pa `Save'
button and reboot your system.
Now, you should see the OF command prompt:
.Dl 0 >
If your screen is black, then your model does not support using the screen in
Open Firmware.  You will need to hook up a serial console (38400 bps,
8 bits, no parity, 1 stop bit, no handshaking).
.(Note
Unfortunately, there are a few models that are better off without the System Disk patches.
If you find that your machine doesn't boot, then try:
.Dl 0 > Ic setenv use-nvramrc? false
.Dl 0 > Ic reset-all
.Note)
.It
.Em Getting to the OF prompt (harder, using MacOS)
.Pp
If System Disk doesn't work because your version of MacOS is too old or because
System Disk says that it doesn't support your model, then you may try using
the BootVars tool.  
.Pp
.Lk ftp://ftp.netbsd.org/pub/NetBSD/arch/macppc/macos-utils/bootvars/bootvars.sit.hqx
.(Note
BootVars does 
.Em not
apply the (possibly critical) NVRAM patches that System Disk does.  Expect devices to not work.
.Note)
.Pp
Look up the proper
.Pa output-device
for your model on the 
.Nx*M
Model Support webpage.
.Lk http://www.netbsd.org/Ports/macppc/models.html
.Pp
Launch the MacOS BootVars tool.  Click on the
.Pa `auto-boot?'
checkbox, then click on the
.Pa `All Variables'
checkbox and type 
.Pa `kbd'
(without the quotes) into the
.Pa `input-device'
blank, and the proper device name into the
.Pa `output-device'
blank.  Click on the
.Pa `write'
button, and restart.
.Pp
If your 
.Pa `output-device'
is 
.Pa /chaos/control
(i.e. you have a PowerMacintosh 7300 - 8600 system), there is a chance that your monitor will
not sync.  See
.Lk http://www.netbsd.org/Ports/macppc/SystemDisk-tutorial/of105patch.html
.Pp
If your model does not have an
.Pa `output-device'
listed, or its screen is black when you restart your system, then it
has defaulted to using a serial console because the internal video does not work.
This is fairly common on these models if you do not use
the System Disk tool to set up OF.  You must hook up a serial console (38400 bps,
8 bits, no parity, 1 stop bit, no handshaking).
.Pp
Now, you should see the OF command prompt:
.Dl 0 >
.It
.Em Getting to the OF prompt (without using MacOS)
.Pp
If you don't have MacOS, then you need to hold down a special key combination when your system
boots.
.(Note
Your system will
.Em not
have the (possibly critical) NVRAM patches that System Disk applies.  Expect devices to not work.
.Note)
.Pp
After the chime starts, but before it stops, hold down the 
.Pa `Command', `Option', `o',
and
.Pa `f'
keys (the
.Pa `Command'
key looks like a four-leaf clover or an open apple, and the 
.Pa `Option'
key may look like a two-way switch with four straight line segments).
.Pp
Now, your machine is at the Open Firmware command prompt.  If your screen is black, then your system
has defaulted to using a serial console.  This is fairly common on these models if you do not use
the System Disk tool to set up OF.  You must hook up a serial console (38400 bps,
8 bits, no parity, 1 stop bit, no handshaking).
.Pp
Now, you should see the OF command prompt:
.Dl 0 >
Look up the proper
.Pa output-device
for your model on the 
.Nx*M
webpages and set this variable at the OF prompt.
.Lk http://www.netbsd.org/Ports/macppc/models.html
.Pp
Run the following commands to use your screen instead of a serial console (replace
.Pa `screen'
with the correct
.Pa output-device
for your model):
.Dl 0 > Ic setenv output-device screen
.Dl 0 > Ic setenv input-device kbd
.Dl 0 > Ic reset-all
Now you should see the OF prompt on your screen.
.Pp
If your 
.Pa `output-device'
is 
.Pa /chaos/control
(i.e. you have a PowerMacintosh 7300 - 8600 system), there is a chance that your monitor will
not sync.  See
.Lk http://www.netbsd.org/Ports/macppc/SystemDisk-tutorial/of105patch.html
.It
.Em Setting OF up to boot NetBSD
.Pp
Double-check that your system is indeed OF versions 1.x or 2.0.x:
.Dl 0 > Ic dev /openprom
.Dl 0 > Ic .properties
If it is not, then skip forward to the appropriate section for your version of OF and do 
.Em not
run the following two commands.  If your system is OF 1.x or 2.0.x, then
you must set some OF variables before 
.Nx
can boot.
.Dl 0 > Ic setenv load-base 600000
.Dl 0 > Ic setenv real-base F00000
.Dl 0 > Ic reset-all
The last command reboots your machine so that the 
.Pa real-base
setting takes effect.
.Pp
If you will be netbooting your system, you can look up your MAC address.
.Dl 0 > Ic dev enet .properties
.Dl [...]
.Dl     local-mac-address   CCCCCCCC CCCC
.Dl [...]
.(Note
Some early OF 1.0.5 machines had their MAC address stored incorrectly on the motherboard
(little- vs. big-endian problems).  The patches System Disk installs will 
correct this.  Without the patch, the machine will still work, but its MAC address
may conflict with another ethernet device on your network.
.Note)
.Pp
For future reference, when you want to boot into MacOS, type:
.Dl 0 > Ic bye
.(Note
Open Firmware 1.0.5 settings will be erased if you boot into MacOS.  
You will need to re-enter them before booting
.Nx
again.  OF 2.0.x does not appear to suffer from this problem.
.Note)
.enum)
.
.Ss2 Open Firmware 1.1.22 System Preparation
.
.(enum
.Em Getting to the OF prompt
.Pp
You need to hold down a special key combination when your system
boots.  After the chime starts, but before it stops, hold down the 
.Pa `Command', `Option', `o',
and
.Pa `f'
keys (the
.Pa `Command'
key looks like a four-leaf clover or an open apple, and the 
.Pa `Option'
key may look like a two-way switch with four straight line segments).
.Pp
Your Apple Network Server
has defaulted to using a serial console.  You must hook up a serial console (38400 bps,
8 bits, no parity, 1 stop bit, no handshaking) to 
.Pa `Port 2'
(which is the
.Pa `ttya'
device in OF).
.Pp
Now, you should see the OF command prompt:
.Dl 0 >
.It
.Em Setting OF up to boot NetBSD
.Pp
You must set some OF variables before 
.Nx
can boot.
.Dl 0 > Ic setenv load-base 600000
.Dl 0 > Ic setenv real-base F00000
.Dl 0 > Ic reset-all
The last command reboots your machine so that the 
.Pa real-base
setting takes effect.
.Pp
If you will be netbooting your system, you can look up your MAC address.
.Dl 0 > Ic dev enet .properties
.Dl [...]
.Dl     local-mac-address   CCCCCCCC CCCC
.Dl [...]
.enum)
.
.Ss2 Open Firmware 2.4 System Preparation
.
.(enum
.Em Getting to the OF prompt (easy, using MacOS)
.Pp
Launch the MacOS System Disk tool.  Click on 
.Pa `Power User (Open Firmware)'
then click on the
.Pa `Advanced Options'
button.  Now, click on the checkbox that says
.Pa `Stop Boot at Open Firmware prompt'
and hit
.Pa `OK'.
Click the
.Pa `Save'
button and reboot your system.
Now, you should see the OF command prompt:
.Dl 0 >
.It
.Em Getting to the OF prompt (without using MacOS)
.Pp
If you don't have MacOS, then you need to hold down a special key combination when your system
boots.  After the chime starts, but before it stops, hold down the 
.Pa `Command', `Option', `o',
and
.Pa `f'
keys (the
.Pa `Command'
key looks like a four-leaf clover or an open apple, and the 
.Pa `Option'
key may look like a two-way switch with four straight line segments).
.Pp
Now, you should see the OF command prompt:
.Dl 0 >
.(Note
You must install the patches from System Disk before your beige G3 will boot
.Nx
.Note)
.It
.Em Setting OF up to boot NetBSD
.Pp
Double-check that your system is indeed OF version 2.4:
.Dl 0 > Ic dev /openprom
.Dl 0 > Ic .properties
If it is not, then skip to the appropriate section for your version of OF and do 
.Em not
run the following two commands.  If your system is OF 2.4, then
you must set some OF variables before 
.Nx
can boot.
.Dl 0 > Ic setenv load-base 600000
.Dl 0 > Ic setenv real-base F00000
.Dl 0 > Ic reset-all
The last command reboots your machine so that the 
.Pa real-base
setting takes effect.
.Pp
If you will be netbooting your system, you can look up your MAC address.
.Dl 0 > Ic dev enet .properties
.Dl [...]
.Dl     local-mac-address   CCCCCCCC CCCC
.Dl [...]
.Pp
For future reference, when you want to boot into MacOS, type:
.Dl 0 > Ic bye
.enum)
.
.Ss2 Open Firmware 3 System Preparation
.
.(enum
.Em Updating your firmware
.Pp
OF 3 systems have a rewritable firmware.  Go to the `Apple Software Updates' web site,
search for 
.Pa `firmware'
and install the most recent version for your model.
.Lk http://asu.info.apple.com/
.It
.Em Getting to the OF prompt (using MacOS)
.Pp
Launch the MacOS System Disk tool.  Click on 
.Pa `Power User (Open Firmware)'
then click on the
.Pa `Advanced Options'
button.  Now, click on the checkbox that says
.Pa `Stop Boot at Open Firmware prompt'
and hit
.Pa `OK'.
Click the
.Pa `Save'
button and reboot your system.
Now, you should see the OF command prompt:
.Dl 0 >
.(Note
This setting is persistent.  Until you disable 
.Pa `Stop Boot at Open Firmware prompt'
or tell OF 
.Ic ``setenv auto-boot? true''
your system will always stop at the OF prompt.
.Note)
.It
.Em Getting to the OF prompt (without using MacOS)
.Pp
If you don't have MacOS, then you need to hold down a special key combination when your system
boots.  After the chime starts, but before it stops, hold down the 
.Pa `Command', `Option', `o',
and
.Pa `f'
keys (the
.Pa `Command'
key looks like a four-leaf clover or an open apple, and the 
.Pa `Option'
key may look like a two-way switch with four straight line segments).
.Pp
Now, you should see the OF command prompt:
.Dl 0 >
.It
.Em Setting OF up to boot NetBSD
.Pp
Double-check that your system is indeed OF version 3:
.Dl 0 > Ic dev /openprom
.Dl 0 > Ic .properties
If it is not, then skip back to the appropriate section for your version of OF.
.Pp
If you will be netbooting your system, you can look up your MAC address.
.Dl 0 > Ic dev enet .properties
.Dl [...]
.Dl     local-mac-address   CCCCCCCC CCCC
.Dl [...]
.(Note
Some OF 3 machines have their MAC address stored incorrectly 
(little- vs. big-endian problem).  If you look up your MAC address in MacOS,
it will be different than what OF 3 uses to contact your netboot server.  Your
machine will still work, but its MAC address may conflict with another ethernet
device on your network.
.Note)
.Pp
For future reference, when you want to boot into MacOS, type:
.Dl 0 > Ic mac-boot
.enum)
