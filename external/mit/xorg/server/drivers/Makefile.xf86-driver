#	$NetBSD: Makefile.xf86-driver,v 1.4 2008/08/09 11:18:05 rtr Exp $

NOSHLIB_VERSION=1	# defined

.include <bsd.own.mk>
.include <bsd.x11.mk>

LIB=	${DRIVER_NAME}

PRINT_PACKAGE_VERSION=	awk '/^PACKAGE_VERSION=/ {			\
				match($$1, "[0-9]+\.[0-9]+\.[0-9]+");	\
				version = substr($$1, RSTART, RLENGTH);	\
			} END { print version }'			\
			${X11SRCDIR.${DRIVER}}/configure

PACKAGE_VERSION!=	${PRINT_PACKAGE_VERSION}

PRINT_PACKAGE_MAJOR=	echo ${PACKAGE_VERSION} | awk -F. '{	\
				major = $$1;			\
			} END { print major }'
PACKAGE_MAJOR!=		${PRINT_PACKAGE_MAJOR}

PRINT_PACKAGE_MINOR=	echo ${PACKAGE_VERSION} | awk -F. '{	\
				minor = $$2;			\
			} END { print minor }'
PACKAGE_MINOR!=		${PRINT_PACKAGE_MINOR}

PRINT_PACKAGE_PATCH=	echo ${PACKAGE_VERSION} | awk -F. '{	\
				patch = $$3;			\
			} END { print patch }'
PACKAGE_PATCH!=		${PRINT_PACKAGE_PATCH}

CPPFLAGS+=	-I${DESTDIR}${X11INCDIR}/xorg \
		-I${DESTDIR}${X11INCDIR}/pixman-1 \
		-I${X11SRCDIR.xorg-server}/../include \
		${X11FLAGS.DIX} ${X11INCS.DIX}

CPPFLAGS+=	-DPACKAGE_VERSION_MAJOR=${PACKAGE_MAJOR}
CPPFLAGS+=	-DPACKAGE_VERSION_MINOR=${PACKAGE_MINOR}
CPPFLAGS+=	-DPACKAGE_VERSION_PATCHLEVEL=${PACKAGE_PATCH}
CPPFLAGS+=	-DXORG_VERSION_CURRENT=${XORG_VERSION_CURRENT}

.PATH:	${X11SRCDIR.${DRIVER}}/src
.PATH:	${X11SRCDIR.${DRIVER}}/man

MKLINT=	no

# XXX want no _pic.a
# XXX want a _JUST_ .so
# XXX want a libtool .la?

XMODULEDIR?=	${X11USRLIBDIR}/modules/drivers

libinstall:: moduleinstall

.if !target(moduleinstall)
_MODULE:=	${DESTDIR}${XMODULEDIR}/${DRIVER_NAME}.so

.if ${MKUPDATE} == "no"
${_MODULE}!	lib${DRIVER_NAME}.so			# install rule
.if !defined(BUILD) && !make(all) && !make(${DRIVER_NAME}.so)
${_MODULE}!	.MADE					# no build at install
.endif
.else
${_MODULE}:	lib${DRIVER_NAME}.so			# install rule
.if !defined(BUILD) && !make(all) && !make(${DRIVER_NAME}.so)
${_MODULE}:	.MADE					# no build at install
.endif
.endif
	${INSTALL_FILE} -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
	    ${SYSPKGTAG} ${.ALLSRC} ${.TARGET}

moduleinstall::	${_MODULE}
.PHONY:		moduleinstall
.PRECIOUS:	${_MODULE}                              # keep if install fails

.endif  # !target(moduleinstall)

.include <bsd.lib.mk>
