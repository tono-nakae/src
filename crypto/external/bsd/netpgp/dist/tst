#! /bin/sh

while [ $# -gt 0 ]; do
	case "$1" in
	-v)
		set -x
		;;
	*)
		break
		;;
	esac
	shift
done

env USETOOLS=no MAKEOBJDIRPREFIX=/usr/obj/i386 sh -c 'cd ../lib && \
	make cleandir ; \
	su root -c "make includes"; \
	make ; \
	su root -c "make install"'
env USETOOLS=no MAKEOBJDIRPREFIX=/usr/obj/i386 sh -c 'cd ../netpgp && \
	make cleandir ; \
	make ; \
	su root -c "make install"'
env USETOOLS=no MAKEOBJDIRPREFIX=/usr/obj/i386 sh -c 'cd ../netpgpkeys && \
	make cleandir ; \
	make ; \
	su root -c "make install"'
env USETOOLS=no MAKEOBJDIRPREFIX=/usr/obj/i386 sh -c 'cd ../netpgpverify && \
	make cleandir ; \
	make ; \
	su root -c "make install"'

passed=0
total=19
echo "======> sign/verify 180938 file"
cp configure a
/usr/bin/netpgp --sign a
/usr/bin/netpgp --verify a.gpg && passed=$(expr $passed + 1)
echo "======> attempt to verify an unsigned file"
/usr/bin/netpgp --verify a || passed=$(expr $passed + 1)
echo "======> encrypt/decrypt 10809 file"
cp src/netpgp/netpgp.1 b
/usr/bin/netpgp --encrypt b
/usr/bin/netpgp --decrypt b.gpg
diff src/netpgp/netpgp.1 b && passed=$(expr $passed + 1)
echo "======> encrypt/decrypt 180938 file"
cp configure c
/usr/bin/netpgp --encrypt c
/usr/bin/netpgp --decrypt c.gpg
diff configure c && passed=$(expr $passed + 1)
echo "======> encrypt/decrypt bigass file"
cat configure configure configure configure configure configure > d
ls -l d
cp d e
/usr/bin/netpgp --encrypt d
/usr/bin/netpgp --decrypt d.gpg
diff e d && passed=$(expr $passed + 1)
echo "======> sign/verify detached signature file"
cat configure configure configure configure configure configure > f
/usr/bin/netpgp --sign --detached f
ls -l f f.sig
/usr/bin/netpgp --verify f.sig && passed=$(expr $passed + 1)
echo "======> cat signature - verified cat command"
/usr/bin/netpgp --cat a.gpg > a2
diff a a2 && passed=$(expr $passed + 1)
echo "======> another cat signature - verified cat command"
/usr/bin/netpgp --cat --output=a3 a.gpg
diff a a3 && passed=$(expr $passed + 1)
echo "======> netpgp list-packets test"
/usr/bin/netpgp --list-packets || passed=$(expr $passed + 1)
echo "======> version information"
/usr/bin/netpgp --version
echo "======> netpgpverify file"
/usr/bin/netpgpverify a.gpg && passed=$(expr $passed + 1)
echo "======> attempt to verify an unsigned file"
/usr/bin/netpgpverify a || passed=$(expr $passed + 1)
echo "======> sign/verify detached signature file"
ls -l f f.sig
/usr/bin/netpgpverify f.sig && passed=$(expr $passed + 1)
echo "======> another verify signature - verified cat command"
/usr/bin/netpgpverify --output=a3 a.gpg
diff a a3 && passed=$(expr $passed + 1)
echo "======> list keys"
/usr/bin/netpgpkeys --list-keys && passed=$(expr $passed + 1)
echo "======> null file to verify"
/usr/bin/netpgp --verify || passed=$(expr $passed + 1)
echo "======> null file to sign"
/usr/bin/netpgp --sign || passed=$(expr $passed + 1)
echo "======> null file to encrypt"
/usr/bin/netpgp --encrypt || passed=$(expr $passed + 1)
echo "======> null file to decrypt"
/usr/bin/netpgp --decrypt || passed=$(expr $passed + 1)
echo "======> version information"
/usr/bin/netpgpverify --version
echo "======> find specific key information"
/usr/bin/netpgpkeys --get-key c0596823 agc@netbsd.org && passed=$(expr $passed + 1)
rm -f a a.gpg b b.gpg c c.gpg d d.gpg e f f.sig a2 a3
echo "Passed ${passed}/${total} tests"
